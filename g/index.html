<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<title>Guest</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.4.4/lz-string.min.js"></script>
<style>
body { font-family: monospace; margin: 20px; }
</style>
</head>
<body>

<h2>Guest</h2>

<input id="codeInput" placeholder="ë°© ì½”ë“œ 8ìë¦¬ ì…ë ¥" />
<button onclick="join()">Join</button>

<pre id="log"></pre>

<script>
const WORKER = "https://chat.keddie213.workers.dev/";

let pc, channel;
function log(t){ document.getElementById("log").textContent += t+"\n"; }

async function join(){
  const code = document.getElementById("codeInput").value.trim();
  if(code.length != 8) return alert("8ìë¦¬ ì½”ë“œ ì…ë ¥!");

  log("ğŸ“¡ Offer ê°€ì ¸ì˜¤ëŠ” ì¤‘...");

  let offerEnc = await fetch(WORKER + code);
  if(!offerEnc.ok) return log("âŒ Offer ì—†ìŒ");

  let offerData = await offerEnc.text();
  let sdp = LZString.decompressFromEncodedURIComponent(offerData);

  pc = new RTCPeerConnection();
  pc.ondatachannel = ev=>{
    channel = ev.channel;
    channel.onmessage = e=> log("ğŸ‘¤ Host: " + e.data);
    channel.onopen = ()=> log("ğŸ”µ ì—°ê²°ë¨!");
  };

  await pc.setRemoteDescription({ type:"offer", sdp });

  let answer = await pc.createAnswer();
  await pc.setLocalDescription(answer);

  let ansCompressed = LZString.compressToEncodedURIComponent(answer.sdp);

  // Workerì— answer ì €ì¥
  await fetch(WORKER + code + "_ans", {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({ data: ansCompressed })
  });

  log("ğŸ“¨ Answer ì „ì†¡ ì™„ë£Œ!");
}
</script>

</body>
</html>
