<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Host</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.4.4/lz-string.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<style>
 body { background:#0c0c0f; color:#eee; font-family:monospace; padding:20px; }
</style>
</head>
<body>

<h2>Host</h2>
<button onclick="start()">Create Offer & QR</button>

<div id="qrcode" style="margin-top:20px;"></div>

<h3>Answer 입력:</h3>
<textarea id="answerBox" style="width:100%;height:120px;"></textarea>
<button onclick="applyAnswer()">Apply</button>

<pre id="log"></pre>

<script>
const WORKER_URL = "https://chat.keddie213.workers.dev/";

function log(t){ document.getElementById("log").textContent += t + "\n"; }

function generateCode8(){
    const c = "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
    let out = "";
    for(let i=0;i<8;i++) out += c[Math.floor(Math.random()*c.length)];
    return out;
}

function minimize(sdp){
    const allowed = [
        "v=","o=","s=","t=",
        "a=ice-ufrag","a=ice-pwd","a=fingerprint","a=setup",
        "m=application","a=sctp-port","a=max-message-size"
    ];
    return sdp.split("\n").filter(l => allowed.some(k => l.startsWith(k))).join("\n");
}

function compressToLimit(sdp){
    let min = minimize(sdp);
    let comp = LZString.compressToEncodedURIComponent(min);
    if (comp.length < 770) comp += "_".repeat(770 - comp.length);
    if (comp.length > 800) comp = comp.slice(0,800);
    return comp;
}

let pc, channel;

async function start(){
    pc = new RTCPeerConnection();
    channel = pc.createDataChannel("chat");
    channel.onmessage = e => log("Guest: " + e.data);

    const offer = await pc.createOffer();
    await pc.setLocalDescription(offer);

    let compressed = compressToLimit(pc.localDescription.sdp);

    let code = generateCode8();

    // Worker 업로드
    await fetch(WORKER_URL, {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({ code:code, data:compressed })
    });

    // QR 출력
    new QRCode(document.getElementById("qrcode"), WORKER_URL + code);

    log("방 코드: " + code);
    log("QR 생성됨.");
}

async function applyAnswer(){
    let ans = document.getElementById("answerBox").value.trim();
    let sdp = LZString.decompressFromEncodedURIComponent(ans);
    await pc.setRemoteDescription({ type:"answer", sdp });
    log("answer 적용됨.");
}

</script>
</body>
</html>
