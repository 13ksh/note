<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<title>Host</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.4.4/lz-string.min.js"></script>
<style>
body { font-family: monospace; margin: 20px; }
.codeBox{
  font-size:40px; border:2px dashed #333; padding:10px; display:inline-block;
}
</style>
</head>
<body>

<h2>Host</h2>
<button onclick="startHost()">Create Offer</button>

<div id="codeBox" class="codeBox"></div>

<pre id="log"></pre>

<script>
const WORKER = "https://chat.keddie213.workers.dev/";

let pc, channel;
function log(t){ document.getElementById("log").textContent += t+"\n"; }

function rand8(){
  const c = "ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
  let out="";
  for(let i=0;i<8;i++) out += c[Math.floor(Math.random()*c.length)];
  return out;
}

function minimize(sdp){
  const keep = [
    "v=","o=","s=","t=",
    "a=ice-ufrag","a=ice-pwd","a=fingerprint","a=setup",
    "m=application","a=sctp-port","a=max-message-size",
    "a=candidate"
  ];

  return sdp.split("\n").filter(line =>
    keep.some(k => line.startsWith(k))
  ).join("\n");
}

function compressSmall(sdp){
  const minimized = minimize(sdp);  // ICE í›„ë³´ ì‚´ë¦¬ê¸°
  return LZString.compressToEncodedURIComponent(minimized);
}

async function startHost(){
  pc = new RTCPeerConnection();
  channel = pc.createDataChannel("msg");
  channel.onopen = ()=> log("ðŸ”µ ì±„íŒ… ì—´ë¦¼");
  channel.onmessage = ev => log("ðŸ‘¤ Guest: " + ev.data);

  let offer = await pc.createOffer();
  await pc.setLocalDescription(offer);

  let code = rand8();
  document.getElementById("codeBox").innerText = code;

  let compressed = compressSmall(pc.localDescription.sdp);

  await fetch(WORKER + code, {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify({ data: compressed })
  });

  log("ðŸ“¨ Offer ì €ìž¥ë¨. ì½”ë“œ ì „ë‹¬í•˜ì„¸ìš”: " + code);

  pollAnswer(code);
}


// Guestì˜ answer ê¸°ë‹¤ë¦¼
async function pollAnswer(code){
  log("â³ Answer ê¸°ë‹¤ë¦¬ëŠ” ì¤‘...");

  while(true){
    let res = await fetch(WORKER + code + "_ans");
    if(res.ok){
      let enc = await res.text();
      let sdp = LZString.decompressFromEncodedURIComponent(enc);
      await pc.setRemoteDescription({ type:"answer", sdp });
      log("âœ… Answer ì ìš© ì™„ë£Œ!");
      break;
    }
    await new Promise(r=>setTimeout(r, 1000));
  }
}
</script>

</body>
</html>
