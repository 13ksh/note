<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Host</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.4.4/lz-string.min.js"></script>
<style>
 body { font-family: Arial; padding:20px; }
 #codeBox {
   font-size:32px;
   width:200px;
   text-align:center;
   padding:10px;
   border:2px dashed #555;
   margin-top:20px;
   background:#f7f7f7;
 }
 textarea { width:100%; height:100px; margin-top:10px; }
 pre { background:#eee; padding:10px; margin-top:20px; }
</style>
</head>
<body>

<h2>HOST</h2>
<button onclick="startHost()">Create Offer</button>
<div id="codeBox">NO CODE</div>

<h3>Guest answer 입력</h3>
<textarea id="ansBox"></textarea>
<button onclick="applyAnswer()">Apply Answer</button>

<pre id="log"></pre>

<script>
const SERVER = "https://chat.keddie213.workers.dev/";

function log(t){ document.getElementById("log").textContent += t + "\n"; }

function gen8(){
  const s="ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
  return Array(8).fill(0).map(()=>s[Math.floor(Math.random()*s.length)]).join("");
}

function minimize(sdp){
  const keep=["v=","o=","s=","t=","a=ice-ufrag","a=ice-pwd","a=fingerprint","a=setup","m=application","a=sctp-port"];
  return sdp.split("\n").filter(l => keep.some(k=>l.startsWith(k))).join("\n");
}

function compress(sdp){
  let m = minimize(sdp);
  return LZString.compressToEncodedURIComponent(m);
}

let pc, code;

async function startHost(){
  pc = new RTCPeerConnection();
  pc.createDataChannel("chat");

  const offer = await pc.createOffer();
  await pc.setLocalDescription(offer);

  code = gen8();
  document.getElementById("codeBox").textContent = code;

  const cmp = compress(pc.localDescription.sdp);

  await fetch(SERVER, {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify({ code, data:cmp })
  });

  log("Offer 저장됨. 코드: " + code);
  log("게스트에게 CODE만 알려줘.");
}

async function applyAnswer(){
  const raw = document.getElementById("ansBox").value.trim();
  const sdp = LZString.decompressFromEncodedURIComponent(raw);

  await pc.setRemoteDescription({ type:"answer", sdp });
  log("ANSWER 적용됨. 연결 완료.");
}
</script>
</body>
</html>
